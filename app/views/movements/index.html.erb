<html lang="en">
<head>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />
	<script src="http://code.jquery.com/jquery-1.8.3.js"></script>
	<script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
	<link rel="stylesheet" href="/resources/demos/style.css" />
	<script>
	$(function() {
					$( "#datepicker" ).datepicker();
				 });
	</script>
</head>
<body id='#my_page'>
<h1>Reporting</h1>

<li>Total turnover for today: <%= Movement.where(:movement_date =>Date.today).sum("turnover")%></li>
<li>Total turnover for this week: <%= Movement.where(:movement_date => Date.today-6..Date.today).sum("turnover")%></li>
<li>Best seller for today: <%= if !Movement.where(:movement_date =>Date.today).empty? 
							then Movement.where(:movement_date =>Date.today).select("article_code, sum(turnover)").group("article_code").order("sum(turnover) DESC").first.article_code
							else 0
							end%>
							<%= if !Movement.where(:movement_date =>Date.today).empty? 
								then Article.where(:article_code =>Movement.where(:movement_date =>Date.today).select("article_code, sum(turnover)").group("article_code").order("sum(turnover) DESC").first.article_code).first.article_text
								else 0
								end%>
</li>
<li>Best seller for this week: <%= if !Movement.where(:movement_date => Date.today-6..Date.today).empty?
								then Movement.where(:movement_date => Date.today-6..Date.today).select("article_code, sum(turnover)").group("article_code").order("sum(turnover) DESC").first.article_code
								else 0
									end%>
								<%= if !Movement.where(:movement_date => Date.today-6..Date.today).empty?
								then Article.where(:article_code =>Movement.where(:movement_date => Date.today-6..Date.today).select("article_code, sum(turnover)").group("article_code").order("sum(turnover) DESC").first.article_code).first.article_text
								else 0
								end%><link rel="stylesheet" type="text/css" href="/css/ui-lightness/jquery-ui-1.8.5.custom.css" />
</li>	
	</br>	
	<div>Date: <input type="text" id="datepicker"/></div> 
	<div id="result"> Turnover: </div>	
	<div class="result2"></div>
	
	
	<br />
	<h1>Listing movements</h1>
	<table cellspacing="0" cellpadding="3px" rules="all" 
	   style="border:solid 1px #777777; border-collapse:collapse; font-family:verdana; font-size:11px;"> 
	   <tr style="background-color:lightgrey;"> 
	      <th style="width:150px;">Article code</th> 
	      <th style="width:150px;">Movement Date</th> 
	      <th style="width:150px;">Turnover</th> 
	      <th style="width:150px;">Quantity</th> 
	   </tr> 
	   <% @movements.each do |movement| %>
		<tr> 
	      	<td style="padding-left:10px; color:midnightblue;"><%= movement.article_code %></td> 
	      	<td style="padding-left:10px; color:midnightblue;"><%= movement.movement_date %></td> 
	      	<td style="padding-left:10px; color:midnightblue;"><%= movement.turnover %></td> 
			<td style="padding-left:10px; color:midnightblue;"><%= movement.quantity %></td> 
			<td><%= link_to 'Show', movement %></td>
		    <td><%= link_to 'Edit', edit_movement_path(movement) %></td>
		    <td><%= link_to 'Destroy', movement, :method => :delete, :data => { :confirm => 'Are you sure?' } %></td>
		  </tr>
		<% end %>
	</table>

	<br />

	<%= link_to 'New Movement', new_movement_path %>
	
<script>
$(document).ready(function(){

	var $datepicker = $("#datepicker"),
	 	currentDate = new Date(),
		dateString = "";
	
	$datepicker.change(function(){
				
				// Get the selected date
			 	currentDate = $datepicker.datepicker( "getDate" );
				// Convert the date to desired format
				dateString = $.datepicker.formatDate("yy-mm-dd", currentDate);	
				
				// Rule: Never use alert() but console.log()
				//console.log("My dateString is: "+dateString);
				
			$.ajax({
				  type: "POST",
				  // You're sending the variable to your Ruby on Rails controller
				  url: "movements/sort/",
				  data: {"date":dateString},
				}).done(function(data) {
				  	$("#result").html("<p>Turnover: </p>" + data)
				});							
			});	
});
</script>		
</body>
</html>